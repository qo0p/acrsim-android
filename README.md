# ИНСТРУКЦИЯ РАЗРАБОТЧИКА КОНТРОЛЬНО-КАССОВОЙ МАШИНЫ НА БАЗЕ ОС ANDROID ДЛЯ ИНТЕГРАЦИИ ФИСКАЛЬНОГО МОДУЛЯ ВЕРСИИ 0400

## ТЕРМИНЫ И ОПРЕДЕЛЕНИЯ

* __ОС__ - Операционная система
* __ККМ__ - Котрольно-кассовая машина.
* __ISO7816__ - Стандарт относится к смарт-картам (в первую очередь контактным). Описывает форму карты, контактов, их расположение и назначение; протоколы обмена и некоторые аспекты работы с данными. 
* __ФМ__ - Фискальный модуль, смарт-карта или USB-токен с ОС JavaCard и установленным апплетов выполняющего функцию фискального модуля.
* __ФП__ - Фискальный признак чека.
* __TLV__ - «Tag-Length-Value» широко распространённый метод записи коротких данных в компьютерных файлах и телекоммуникационных протоколах. 
* __ZReport__ - Запись в ФМ хранит дату-время открытия и закрытия дня и накопленные суммы продаж, возвратов и НДС.
* __ZReportFile__ - Зашифрованный и подписанны ЭЦП ZReport-файл, предназначен для отправки на сервер.
* __Receipt__ - Запись в ФМ хранит дату-время, тип, сумму чека до тех пор пока не произойдет синхронизация с сервером.
* __ReceiptFile__ - Зашифрованный и подписанны ЭЦП Receipt-файл, предназначен для отправки на сервер.
* __AckFile__ - Файл получаемый от сервера для передачи в ФМ для подтверждения доставки ZReport и Receipt.  
* __SyncFile__ - Файл получаемый от сервера для передачи в ФМ для синхронизации времени, состояния ФМ с сервером.  
* __SyncChallenge__ - Применяется при синхронизации времени, состояния ФМ с сервером.



## ВВЕДЕНИЕ

В инструкции приведены описания и принцып работы ФМ версии 0400, примерный проект android-приложения и описания методов для взаимодействия с ФМ

## ФМ версия 0400

Отличия ФМ версии 0400 от прежних версий:

* __Защита от случайной установки будущей даты-врмени__, еслм передаваемое дата-время больше на 2 дня чем дата-время последней операции в ФМ, то ФМ возвратом кода ошибки потребует синхронизацию с сервером для установки серверного даты-время в ФМ.
* __Нет ограничения на кол-во записей ZReport__, Максимальное кол-во зависит от доступной физ.памяти ФМ.
* __Кол-во операции продажа и возврат в одном ZReport до 29999__, в прежних версиях ФМ было до 9999.
* __Нет ограничения на кол-во записей Receipt__, Максимальное кол-во зависит от доступной физ.памяти ФМ.
* __Добавлены типы чеков Аванс и Кредит__, Для этих типов чеков ФМ также выдает порядковый номер чека, но не выдает ФП.
* __Добавлена возможность аутентификации по ФМ__ в IT-системах.
* __Добавлена опция привязки ФМ к POS-системе или ККМ__, при открытии/закрытии ZReport или регистрации чека ФМ потребует секретный ключ.
* __Идемпотентность операций ФМ__, При регистрации чека передача одной и той же команды (много раз) в ФМ будет выполненя одна операция и выдача одного и того же результата (много раз).
* __Выполнена оптимизация работы ФМ__, Сокращено кол-во инструкций и возвращаемых кодов ошибок в ФМ. Данные из ФМ можно запрашивать частично передавая TLV-теги запрашиваемых полей.
* __Разработан эмулятор ФМ__, Для разработки и тестирования ПО для ККМ больше не требуется физ.ФМ, можно запустить программный эмулятор ФМ версии 0400 (входит в состав ПО FiscalDriveService v10).
* __Нет обратной совместимости__ по кодам инструкций, кодам возврата и структурой данных с ФМ прежних версий.

## Коды возврата

ФМ всегда (по ISO7816) возвращает 2х байтовый код после выполнения инструкции. Если ответ от ФМ не вернулся,то скорее всего проблема в драйвере SAM-считывателя.

| Код      | Название                                | Описание                                                                                                                                                                                                    |
|----------|-----------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `0x9000` | `NO_ERROR`                              | Успешно                                                                                                                                                                                                     |
| `0x9010` | `INVALID_DATETIME`                      | Передано неправильное значение даты-времени (должно быть в формате BCDDateTime)                                                                                                                             |
| `0x9011` | `INVALID_INDEX`                         | Передано неправильное значение индекса (должно быть от 0 до 32767)                                                                                                                                          |
| `0x9012` | `INVALID_BCD`                           | Передано неправильное значение числа (должно быть в формате BCD8)                                                                                                                                           |
| `0x9013` | `INVALID_TYPE`                          | Передано неправильное значение типа чека                                                                                                                                                                    |
| `0x9014` | `INVALID_OPERATION`                     | Передано неправильное значение типа операции                                                                                                                                                                |
| `0x9015` | `INVALID_ACK_SIGNATURE`                 | Передано неправильное значение AckFile                                                                                                                                                                      |
| `0x9016` | `WRONG_TERMINAL_ID`                     | Передано неправильное значение AckFile (возможно AckFile не для этого ФМ)                                                                                                                                   |
| `0x9017` | `INVALID_SYNC_SIGNATURE`                | Передано неправильное значение SyncFile                                                                                                                                                                     |
| `0x9018` | `WRONG_SYNC_CHALLENGE`                  | Передано неправильное значение SyncChallenge (возможно был повторно передан прежний SyncFile)                                                                                                               |
| `0x9020` | `NOT_FOUND`                             | Запрашиваемая запись ненайдена. Может быть при повторной передачи AckFile в ФМ или при передачи индекса для получения записи которого нет в ФМ                                                              |
| `0x9021` | `ZREPORT_IS_NOT_OPENED`                 | Не выполнена операция открытия ZReport                                                                                                                                                                      |
| `0x9022` | `ZREPORT_IS_NOT_CLOSED`                 | Не выполнена операция заккрытия ZReport                                                                                                                                                                     |
| `0x9023` | `ZREPORT_IS_ALREADY_CLOSED`             | ZReport уже был закрыт, выполните операцию открытия ZReport                                                                                                                                                 |
| `0x9030` | `DATETIME_IS_IN_THE_PAST`               | Передаваемое дата-время ранее (прошлое) или равно дате-время последней операции в ФМ (Передаваемое дата-время должно быть как минимум на 1 сек. позьже чем дата-время последней операции в ФМ)              |
| `0x9031` | `SEND_ALL_RECEIPTS_FIRST`               | В ФМ хранятся чеки более чем 2 дня, выполните синхронизацию файлов с сервером                                                                                                                               |
| `0x9032` | `CANNOT_CLOSE_EMPTY_ZREPORT`            | Нельзя выполнить операцию заккрытия ZReport если в нем не заригистрирована минимум 1 операция продажи или возврата                                                                                          |
| `0x9033` | `RECIPT_SEQ_MAX_VALUE_REACHED`          | Достигнут максимальный номмер чека в ФМ. Следует заменить ФМ на новый.                                                                                                                                      |
| `0x9034` | `CASH_CARD_ACCUMULATOR_OVERFLOW`        | Достигнута максимальная накопленная сумма в фискальной памяти ФМ при операции возврат. Следует заменить ФМ на новый.                                                                                        |
| `0x9035` | `NOT_ENOUGH_SUM_FOR_REFUND`             | В фискальной памяти ФМ надостаточно суммы от продаж для выполнения операции возврат                                                                                                                         |
| `0x9036` | `VAT_ACCUMULATOR_OVERFLOW`              | Достигнута максимальная накопленная сумма НДС в фискальной памяти ФМ. Следует заменить ФМ на новый.                                                                                                         |
| `0x9037` | `NOT_ENOUGH_VAT_FOR_REFUND`             | В фискальной памяти ФМ надостаточно суммы НДС от продаж для выполнения операции возврат                                                                                                                     |
| `0x9040` | `TOTAL_COUNT_OVERFLOW_OPEN_NEW_ZREPORT` | Достигнуто максимальное кол-во операций (29999) в текущем ZReport. Закройта текущий ZReport и откройте новый.                                                                                               |
| `0x9041` | `TOTAL_CASH_OVERFLOW_OPEN_NEW_ZREPORT`  | Достигнута максимальная накопленная сумма в текущем ZReport. Закройта текущий ZReport и откройте новый.                                                                                                     |
| `0x9042` | `TOTAL_CARD_OVERFLOW_OPEN_NEW_ZREPORT`  | Достигнута максимальная накопленная сумма в текущем ZReport. Закройта текущий ZReport и откройте новый.                                                                                                     |
| `0x9043` | `TOTAL_VAT_OVERFLOW_OPEN_NEW_ZREPORT`   | Достигнута максимальная накопленная сумма НДС в текущем ZReport. Закройта текущий ZReport и откройте новый.                                                                                                 |
| `0x9044` | `CASH_ACCUMULATOR_OVERFLOW`             | Достигнута максимальная накопленная сумма в фискальной памяти ФМ при операции продажа. Следует заменить ФМ на новый.                                                                                        |
| `0x9045` | `CARD_ACCUMULATOR_OVERFLOW`             | Достигнута максимальная накопленная сумма в фискальной памяти ФМ при операции продажа. Следует заменить ФМ на новый.                                                                                        |
| `0x9090` | `LOCKED_SYNC_WITH_SERVER`               | ФМ заблокирован. Требуется синхронизация состояния ФМ с сервером.                                                                                                                                           |
| `0x9091` | `DATETIME_SYNC_WITH_SERVER`             | Передаваемое дата-время больше на 2 дня чем дата-время последней операции в ФМ. Настройте реальное время в ККМ и повторите попытку или выполните синхронизацию состояния ФМ с сервером и повторите попытку. |
| `0x9092` | `ALREADY_POS_LOCKED`                    | ФМ уже привязан к POS-системе или к ККМ секретным ключем.                                                                                                                                                   |
| `0x9093` | `POS_AUTH_FAIL`                         | ФМ тебует передачи правильного секретного ключа для идентификации POS-системы или ККМ.                                                                                                                      |
| `0x6A86` | `INCORRECT_P1P2`                        | Передано неправильное значение параметров P1,P2                                                                                                                                                             |
| `0x6D00` | `INS_NOT_SUPPORTED`                     | Передано неправильное значение параметра INS                                                                                                                                                                |
| `0x6700` | `WRONG_LENGTH`                          | Передано неправильный размер DATA                                                                                                                                                                           |
| `0x6A80` | `WRONG_DATA`                            | Передано неправильное значение DATA                                                                                                                                                                         |

_Другие коды возвращаются OC смарт-карты. См._  [Complete list of APDU responses](https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses)

